#!/bin/bash

# read the number of processes from the command line
# if no argument is provided, default to 1
# if the argument is not a number, default to 1
# if the argument is less than 1, default to 1
# if the argument is greater than 8, default to 8

if [ -z "$1" ]; then
  num_processes=1
else
  if ! [[ "$1" =~ ^[0-9]+$ ]]; then
    num_processes=1
  else
    if [ "$1" -lt 1 ]; then
      num_processes=1
    elif [ "$1" -gt 8 ]; then
      num_processes=8
    else
      num_processes=$1
    fi
  fi
fi

# the second argument is increases the number of database connections


if [ -z "$2" ]; then
  num_db_connections=1
else
  num_db_connections=$2
fi


# if the number of processes is 1, start the good_job process
# if the number of processes is greater than 1, run as many good_job processes as the number of processes
# but every process should listens 

if [ "$num_processes" -eq 1 ]; then
  GOOD_JOB_EXECUTION_MODE=external DB_JOB=$num_db_connections bundle exec good_job start --queues="queue_0:5;queue_1:5;queue_2:5;queue_3:5;queue_4:5;queue_5:5;queue_6:5;queue_7:5"
elif [ "$num_processes" -eq 2 ]; then
  GOOD_JOB_EXECUTION_MODE=external DB_JOB=$num_db_connections bundle exec good_job start --queues="queue_0:5;queue_2:5;queue_4:5;queue_6:5" & \
    GOOD_JOB_EXECUTION_MODE=external DB_JOB=$num_db_connections bundle exec good_job start --queues="queue_1:5;queue_3:5;queue_5:5;queue_7:5"
elif [ "$num_processes" -eq 4 ]; then
  GOOD_JOB_EXECUTION_MODE=external DB_JOB=$num_db_connections bundle exec good_job start --queues="queue_0:5;queue_4:5" & \
    GOOD_JOB_EXECUTION_MODE=external DB_JOB=$num_db_connections bundle exec good_job start --queues="queue_1:5;queue_5:5" & \
    GOOD_JOB_EXECUTION_MODE=external DB_JOB=$num_db_connections bundle exec good_job start --queues="queue_2:5;queue_6:5" & \
    GOOD_JOB_EXECUTION_MODE=external DB_JOB=$num_db_connections bundle exec good_job start --queues="queue_3:5;queue_7:5"
elif [ "$num_processes" -eq 8 ]; then
  GOOD_JOB_EXECUTION_MODE=external DB_JOB=$num_db_connections bundle exec good_job start --queues="queue_0:5" & \
    GOOD_JOB_EXECUTION_MODE=external DB_JOB=$num_db_connections bundle exec good_job start --queues="queue_1:5" & \
    GOOD_JOB_EXECUTION_MODE=external DB_JOB=$num_db_connections bundle exec good_job start --queues="queue_2:5" & \
    GOOD_JOB_EXECUTION_MODE=external DB_JOB=$num_db_connections bundle exec good_job start --queues="queue_3:5" & \
    GOOD_JOB_EXECUTION_MODE=external DB_JOB=$num_db_connections bundle exec good_job start --queues="queue_4:5" & \
    GOOD_JOB_EXECUTION_MODE=external DB_JOB=$num_db_connections bundle exec good_job start --queues="queue_5:5" & \
    GOOD_JOB_EXECUTION_MODE=external DB_JOB=$num_db_connections bundle exec good_job start --queues="queue_6:5" & \
    GOOD_JOB_EXECUTION_MODE=external DB_JOB=$num_db_connections bundle exec good_job start --queues="queue_7:5"
else
  echo "Invalid number of processes"
  exit 1
fi
